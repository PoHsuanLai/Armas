name: Release

on:
  push:
    tags:
      - "v*.*.*"

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: bash .github/scripts/test.sh

  fmt:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: bash .github/scripts/fmt.sh

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run clippy
        run: bash .github/scripts/clippy.sh

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test, fmt, clippy]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Publish crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: bash .github/scripts/release.sh "${{ steps.version.outputs.VERSION }}"

  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [publish]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          CHANGELOG=""
          for crate_dir in crates/armas-icon crates/armas crates/armas-audio crates/armas-animated; do
            CRATE_NAME=$(basename "$crate_dir")
            if [ -f "$crate_dir/CHANGELOG.md" ]; then
              SECTION=$(sed -n "/^## \[${VERSION}\]/,/^## \[/p" "$crate_dir/CHANGELOG.md" | sed '$d')
              if [ -n "$SECTION" ]; then
                CHANGELOG="${CHANGELOG}### ${CRATE_NAME}\n\n${SECTION}\n\n"
              fi
            fi
          done
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release v${VERSION}"
          fi
          echo -e "$CHANGELOG" > /tmp/release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: v${{ steps.version.outputs.VERSION }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
